# GitHub Actions on Kubernetes - PRè‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆæ™‚ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã€
# Kubernetesä¸Šã®self-hosted runnerã§ä»¥ä¸‹ã®æ¤œè¨¼ã‚’è¡Œã„ã¾ã™:
# 1. ESLinté™çš„è§£æž
# 2. Jestå˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
# 3. npm auditã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
# 4. Webpackæœ¬ç•ªãƒ“ãƒ«ãƒ‰
# 5. çµæžœã‚’ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«åæ˜ 
#
# Runner Pod: k8s/deployment.yamlã§å®šç¾©ã•ã‚ŒãŸmyoung34/github-runnerãŒå®Ÿè¡Œ
name: PR Check

# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒmain/developãƒ–ãƒ©ãƒ³ãƒã«å‘ã‘ã¦ä½œæˆã•ã‚ŒãŸæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼
on:
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    # Kubernetesä¸Šã®self-hosted runner (labels: self-hosted,kubernetes) ã§å®Ÿè¡Œ
    runs-on: self-hosted
    steps:
    # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Node.js 18ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (npmã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    # 3. package.jsonã«åŸºã¥ã„ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dependencies
      run: npm install

    # 4. ESLintã«ã‚ˆã‚‹é™çš„è§£æžå®Ÿè¡Œ (.eslintrc.jsè¨­å®šä½¿ç”¨)
    - name: Run linter
      id: lint
      run: npm run lint

    # 5. Jestã«ã‚ˆã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (__tests__/é…ä¸‹ã®ãƒ†ã‚¹ãƒˆ)
    - name: Run tests
      id: test
      run: npm test

    # 6. npm auditã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
    - name: Run security scan
      id: audit
      run: npm audit

    # 7. Webpackã§æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
    - name: Build application
      id: build
      run: npm run build

    # 8. çµæžœã‚µãƒžãƒªãƒ¼ã‚’å‡ºåŠ›ï¼ˆGitHubæ¨™æº–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’ä½¿ç”¨ï¼‰
    - name: Job Summary
      if: always()
      run: |
        echo "### PR Check Results ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "- Linter: ${{ steps.lint.outcome || 'âœ…' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Tests: ${{ steps.test.outcome || 'âœ…' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security: ${{ steps.audit.outcome || 'âœ…' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build: ${{ steps.build.outcome || 'âœ…' }}" >> $GITHUB_STEP_SUMMARY